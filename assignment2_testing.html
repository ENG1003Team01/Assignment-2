<html>
    <head>
        <!-- Material Design Lite -->
        <script src="https://storage.googleapis.com/code.getmdl.io/1.0.5/material.min.js"></script>
        <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.5/material.indigo-pink.min.css">
        <!-- Material Design icon font -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link href="http:// google.com/mapfiles/ms/micons">
        
        
        
        <meta name="viewport" content="initial-scale=1.0">    
        <meta charset="utf-8">
      
        <style>
            #map {
                height: calc(100% - 136px);
            }   
            
            #start-button {
                background-color: #009934;
                opacity: 0.6;
                float: left;
                width: 50%;
            }
            
            #stop-button {
                background-color: #D12000;
                opacity: 0.6;
                float: right;
                width: 50%;
            }
            
            #clear-button {
                background-color: #D16B00;
                opacity: 0.6;
                float: left;
                width: 50%;
            
            }
            
            #save-button {
                background-color: #056483;
                opacity: 0.6;
                float: right;
                width: 50%;
                
            }
                
            
           
            
        </style>
      
  
    </head>
    
    <body>
      <!-- Always shows a header, even in smaller screens. -->
      <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
          <header class="mdl-layout__header">
              <div class="mdl-layout__header-row">
                  
                  <!-- Title -->
                  <span class="mdl-layout-title">Title</span>
                  
              </div>
      
          </header>
          
     
          <div class="mdl-layout__drawer">
              <span class="mdl-layout-title">Title</span>
              <nav class="mdl-navigation">
                  <a class="mdl-navigation__link" href="">Link</a>
                  <a class="mdl-navigation__link" href="">Link</a>
                  <a class="mdl-navigation__link" href="">Link</a>
                  <a class="mdl-navigation__link" href="">Link</a>
              </nav>
          </div>
          
        
          

        
          <main class="mdl-layout__content">
          
              <div class="page-content">
                  <div id="map"></div>
                  
                  <script>
                      
                      var currentRun = new runningData()
                      var self = this;
                      function runningData(){
                          
                          this.lngCoords = [];
                          this.latCoords = [];
                          this.distance;
                          this.totalTime;
                          this.speed;
                          this.name;
                          this.today;
                      };
                      
                      var testObj = new runStorage()
                      function runStorage(){                      
                          this.runDataArray = [];                        
                      }
                      
                      
                      var today = new Date();
                      var dd = today.getDate();
                      var mm = today.getMonth()+1; //January is 0!
    
                      var yyyy = today.getFullYear();
                      if(dd<10){
                          dd='0'+dd
                      } 
    
                      if(mm<10){
                          mm='0'+mm
                      } 
                      currentRun.today = dd+'/'+mm+'/'+yyyy;
                                            
                      var watchID;
                      
                      var map;
                      
                      var markerStart;
                      var markerStop;
                      var markers = [];
                      
                      var startTime;
                      var endTime;
                      
                      var polyline;
                      var line = [];
                      var path = [];
                      
                      var i = 0;
                      function initMap() {
  
                          map = new google.maps.Map(document.getElementById('map'), {    
                              center: {lat: -34.397, lng: 150.644},    
                              zoom: 15  
                          });
                            
                          var infoWindow = new google.maps.InfoWindow({map: map});  
                            
                          if (navigator.geolocation) {    
                              watchID = navigator.geolocation.watchPosition(function(position) {      
                                  var pos = {        
                                      lat: position.coords.latitude,        
                                      lng: position.coords.longitude      
                                  };
                                  document.getElementById("start-button").disabled = false;
                                  document.getElementById("start-button").style.opacity = "1";

                                  map.setCenter(pos);
                                  currentRun.lngCoords.push(position.coords.longitude);
                                  currentRun.latCoords.push(position.coords.latitude);

                              }, function() {      
                                  handleLocationError(true, infoWindow, map.getCenter());    
                              }, {
                                  enableHighAccuracy: true,
                                  timeout: 5000,
                                  maximumAge: 0
                              });  
                          } else {    
                              // Browser doesn't support Geolocation    
                              handleLocationError(false, infoWindow, map.getCenter());  
                          }
                      
                          //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          
                          document.getElementById("start-button").addEventListener("click", function(event) {
                              startButton(currentRun.lngCoords[currentRun.lngCoords.length - 1],currentRun.latCoords[currentRun.latCoords.length - 1]);
                          });
                          
                          function startButton(longitude, latitude) {
                              
                              startTime = new Date().getTime();
                              
                              var image = 'green-dot';
                              markerStart = new google.maps.Marker({
                                  position: {lat: latitude, lng: longitude},
                                  map: map,
                                  icon: image
                              });
                              markers.push(markerStart)
                              
                              document.getElementById("start-button").disabled = true;
                              document.getElementById("start-button").style.opacity = "0.6";
                              
                              
                              navigator.geolocation.clearWatch(watchID)
                              
                              currentRun.latCoords = [];
                              currentRun.lngCoords = [];                              
                              
                              
                              if (navigator.geolocation) {    
                                  watchID = navigator.geolocation.watchPosition(function(position) {      
                                      var pos = {        
                                          lat: position.coords.latitude,        
                                          lng: position.coords.longitude      
                                      };
                                      document.getElementById("stop-button").disabled = false;
                              document.getElementById("stop-button").style.opacity = "1";
                                      
                                      map.setCenter(pos);
                                      currentRun.lngCoords.push(position.coords.longitude);
                                      currentRun.latCoords.push(position.coords.latitude);
                                      
                                      
                                      
                                      path.push(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
                                      
                                      /*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                                      //%%%%%%%%%%%%%%%%%%%%%%%%% CREATES A PATH FOR TESTING - NEED TO REMOVE %%%%%%%%%%%%%%%%%%%%%%%%
                                      //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                                      for(var i = 0; i < 5; i++) {
                                          path.push(
                                              new google.maps.LatLng(
                                                  position.coords.latitude + (Math.random() / 10 * ((i % 2) ? 1 : -1)),
                                                  position.coords.longitude + (Math.random() / 10 * ((i % 2) ? 1 : -1))
                                              )
                                          );
                                      }
                                      //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%*/
                                      
                                      polyline = new google.maps.Polyline({            
                                          map: map,            
                                          path: path,            
                                          strokeColor: '#0000FF',            
                                          strokeOpacity: 0.7,            
                                          strokeWeight: 2          
                                      });
                                      line.push(polyline)
                                      
                                      //addLatLng(lngCoords[lngCoords.length - 1],latCoords[latCoords.length - 1]-0.001)
                                      
                                  }, function() {      
                                      handleLocationError(true, infoWindow, map.getCenter());    
                                  }, {
                                      enableHighAccuracy: true,
                                      timeout: 5000,
                                      maximumAge: 0
                                  });  
                              } else {    
                                  // Browser doesn't support Geolocation    
                                  handleLocationError(false, infoWindow, map.getCenter());  
                              }
                              
                          }
                          
                          //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          
                          document.getElementById("stop-button").addEventListener("click", function(event) {
                              stopButton(currentRun.lngCoords[currentRun.lngCoords.length - 1],currentRun.latCoords[currentRun.latCoords.length - 1]);
                          });
                          
                          function stopButton(longitude, latitude) {
                              
                              endTime = new Date().getTime();
                              currentRun.totalTime = (endTime - startTime)/1000                              
                              
                              currentRun.distance = google.maps.geometry.spherical.computeLength(polyline.getPath()).toFixed(0)
                              
                              currentRun.speed = (currentRun.distance / currentRun.totalTime).toFixed(2);
                              
                              console.log(currentRun)
                              var image = 'red-dot';
                              markerStop = new google.maps.Marker({
                                  position: {lat: latitude, lng: longitude},
                                  map: map,
                                  icon: image
                              });
                              markers.push(markerStop)                                                                                      
                              
                              navigator.geolocation.clearWatch(watchID)
                              
                              document.getElementById("start-button").disabled = true;
                              document.getElementById("start-button").style.opacity = "0.6";
                              document.getElementById("stop-button").disabled = true;
                              document.getElementById("stop-button").style.opacity = "0.6";
                              document.getElementById("clear-button").disabled = false;
                              document.getElementById("clear-button").style.opacity = "1";
                              document.getElementById("save-button").disabled = false;
                              document.getElementById("save-button").style.opacity = "1";
                          }
                          
                          //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          
                          document.getElementById("clear-button").addEventListener("click", function(event) {
                              clearButton();
                          });
                          
                          function clearButton(){
                              
                              document.getElementById("start-button").disabled = false;
                              document.getElementById("start-button").style.opacity = "1";
                              document.getElementById("clear-button").disabled = true;
                              document.getElementById("clear-button").style.opacity = "0.6";
                              document.getElementById("save-button").disabled = true;
                              document.getElementById("save-button").style.opacity = "0.6";
                              
                              markerStart.setMap(null)    
                              markerStop.setMap(null)
                              
                              for (var j = 0; j < line.length; j++){
                                line[j].setMap(null)
                              }
                              
                              for (var j = 0; j <markers.length; j++){
                                markers[j].setMap(null)
                              }
                              
                              line = [];
                              path = [];
                              markers = [];
                              
                              if (navigator.geolocation) {    
                                  watchID = navigator.geolocation.watchPosition(function(position) {      
                                      var pos = {        
                                          lat: position.coords.latitude,        
                                          lng: position.coords.longitude      
                                      };

                                      map.setCenter(pos);
                                      currentRun.lngCoords.push(position.coords.longitude);
                                      currentRun.latCoords.push(position.coords.latitude);

                                  }, function() {      
                                      handleLocationError(true, infoWindow, map.getCenter());    
                                  }, {
                                      enableHighAccuracy: true,
                                      timeout: 5000,
                                      maximumAge: 0
                                  });  
                              } else {    
                                  // Browser doesn't support Geolocation    
                                  handleLocationError(false, infoWindow, map.getCenter());  
                              }
                              document.getElementById("start-button").addEventListener("click", function(event) {
                                  startButton(currentRun.lngCoords[currentRun.lngCoords.length - 1],currentRun.latCoords[currentRun.latCoords.length - 1]);
                              });
                          
                          }
                          
                          //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          
                          document.getElementById("save-button").addEventListener("click", function(event) {
                              saveButton();
                          });
                          
                          function saveButton(){
                              
                              runName = prompt("Enter in an unique name or press cancel to leave it blank")
                              
                              
                              if (runName == "") 
                              {
                                  currentRun.name = "Untitled"
                              } 
                              else if (runName == null)
                              {
                                  currentRun.name = "Untitled"
                              }
                              else
                              {
                                  currentRun.name = runName
                              }
                              
                              if (JSON.parse(localStorage.getItem('allRunningData'))==null)
                              {
                              
                                  //testObj = JSON.parse(localStorage.getItem('alRunningData'))

                                  testObj.runDataArray.push(currentRun)        

                                  localStorage.setItem('allRunningData', JSON.stringify(testObj))

                                  window.open("https://eng1003.eng.monash.edu/g1skr/slebr1-2","_system")                              
                              }
                              else 
                              {
                                  testObj = JSON.parse(localStorage.getItem('allRunningData'))
                            
                                  testObj.runDataArray.push(currentRun)        
                              
                                  localStorage.setItem('allRunningData', JSON.stringify(testObj))
                              
                                  window.open("https://eng1003.eng.monash.edu/g1skr/slebr1-2","_self") 
                              
                              }
                                                          
                          }
                          
                          
                      }
                      
                                          
                      
                      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                          //infoWindow.setPosition(pos);
                          //infoWindow.setContent(browserHasGeolocation ?
                            //                    'Error: The Geolocation service failed.' :
                              //                  'Error: Your browser doesn\'t support geolocation.');
                          
                      }
                                            
                  </script>
                  
                  <script async defer src="https://maps.googleapis.com/maps/api/js?v=3&amp;key=&amp;callback=initMap"></script>
                  
              </div>
              
              
              
          
          </main>
          
          <div>
          <button id="start-button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" disabled>Start</button>
          <button id="stop-button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" disabled>Stop</button>
          </div>
          
          <div>
          <button id="clear-button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" disabled>Clear</button>
          <button id="save-button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" disabled>Save</button>
          </div>
              
          <script>
              
                   
              
          
          </script>
        </div>
    </body>
</html>